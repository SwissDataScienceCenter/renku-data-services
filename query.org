#+title: testing query
#+PROPERTY: org-confirm-babel-evaluate nil

* notes

Generate values: https://stackoverflow.com/questions/25261511/sql-create-a-table-with-24-hourly-rows

- kind should be group, version and kind
- fix query
- commit in chunks?
- retry network problems
- store interval to the row?


* basic test

#+header: :engine postgres
#+header: :dbhost 127.0.0.1 :database requests :dbuser dev
#+header: :dbpassword dev
#+begin_src sql :exports both
\d resource_requests_log
#+end_src

#+RESULTS:
| SET                                                  |                          |           |          |                 |
|------------------------------------------------------+--------------------------+-----------+----------+-----------------|
| Table "common.resource_requests_log"                 |                          |           |          |                 |
| Column                                               | Type                     | Collation | Nullable | Default         |
| id                                                   | character varying        |           | not null | generate_ulid() |
| cluster_id                                           | character varying        |           |          |                 |
| namespace                                            | character varying        |           | not null |                 |
| name                                                 | character varying        |           | not null |                 |
| uid                                                  | character varying        |           | not null |                 |
| kind                                                 | character varying        |           | not null |                 |
| phase                                                | character varying        |           | not null |                 |
| capture_date                                         | timestamp with time zone |           | not null |                 |
| user_id                                              | character varying        |           |          |                 |
| project_id                                           | character varying        |           |          |                 |
| launcher_id                                          | character varying        |           |          |                 |
| resource_class_id                                    | integer                  |           |          |                 |
| resource_pool_id                                     | integer                  |           |          |                 |
| since                                                | timestamp with time zone |           |          |                 |
| cpu_request                                          | double precision         |           |          |                 |
| memory_request                                       | double precision         |           |          |                 |
| gpu_request                                          | double precision         |           |          |                 |
| disk_request                                         | double precision         |           |          |                 |
| Indexes:                                             |                          |           |          |                 |
| "resource_requests_log_pkey" PRIMARY KEY, btree (id) |                          |           |          |                 |

* grouping per pod

#+header: :engine postgres
#+header: :dbhost 127.0.0.1 :database requests :dbuser dev
#+header: :dbpassword dev
#+begin_src sql :exports both
  select
    uid,
    array_agg(distinct user_id) as user_ids,
    array_agg(distinct launcher_id) as launchers,
    min(capture_date) as min_date,
    max(capture_date) as max_date,
    array_agg(distinct cpu_request) as cpu,
    sum(memory_request) as memory,
    sum(disk_request) as disk,
    array_remove(array_agg(distinct project_id), null) as projects,
    array_remove(array_agg(distinct resource_class_id), null) as resource_classes

  from common.resource_requests_log
  where user_id is not null
    and phase in ('Bound', 'Running')
  --    and kind = 'PersistentVolumeClaim'
  --    and kind = 'Pod'
  group by uid
  order by user_ids, launchers
#+end_src

#+RESULTS:
| SET                                  |                                        |                              |                        |                        |        |             |             |                              |                  |
|--------------------------------------+----------------------------------------+------------------------------+------------------------+------------------------+--------+-------------+-------------+------------------------------+------------------|
| uid                                  | user_ids                               | launchers                    | min_date               | max_date               | cpu    |      memory |        disk | projects                     | resource_classes |
| 8945535b-e1df-423f-b87d-dfe3f415438a | {1a6d4c40-e500-419d-9812-22d6d1c27aa0} | {01K312ATNN2SEMPDE7XZPAX6E7} | 2026-01-22 13:26:04+00 | 2026-01-22 17:06:26+00 | {0}    |           0 | 24696061952 | {01K2HG8GD5W5KGXM9JWE8TY0A5} | {}               |
| 742f4ca2-4602-4624-bf4c-f26baf1a4c98 | {4cf16e99-62fe-4889-90ba-38b2d02bd293} | {01KEESRJZ9TMVM4F0K7QNXDY1A} | 2026-01-22 13:26:04+00 | 2026-01-22 17:06:26+00 | {0}    |           0 | 24696061952 | {01KEER2R11FR8EB22JR5Q1PWV9} | {}               |
| 4756ee2b-7b94-42c9-9b2f-dd783a2863ab | {5daa2891-5310-4428-895d-10f859613223} | {01K82X2T9VKZRH7XQ19NRF2F3F} | 2026-01-22 13:26:04+00 | 2026-01-22 17:06:26+00 | {0}    |           0 | 24696061952 | {01K82WQ20PNMCTDR7A6JD4B3A8} | {}               |
| a53ac5b3-d9af-4d0d-a5b8-169e599901c4 | {c59e6907-e670-4e03-a1b7-18616bb4678e} | {01KCVFZW2N6S20JAY67K30JNJ7} | 2026-01-22 13:36:05+00 | 2026-01-22 16:36:24+00 | {0.54} | 21038628864 |           0 | {01KCVFX9BVTADB8SGHN7RJFJAP} | {}               |
| 5681be8c-3069-49fa-828f-9b489fa210ce | {c59e6907-e670-4e03-a1b7-18616bb4678e} | {01KCVFZW2N6S20JAY67K30JNJ7} | 2026-01-22 13:26:04+00 | 2026-01-22 16:36:24+00 | {0}    |           0 | 21474836480 | {01KCVFX9BVTADB8SGHN7RJFJAP} | {}               |
| 2ab30fe3-2ce5-4bed-9722-05b02603568b | {e25cd000-59be-4e52-86aa-fb4fc60a12c8} | {01KFDKMX7K27GP83NT8MWH08KB} | 2026-01-22 14:06:08+00 | 2026-01-22 14:06:08+00 | {1.04} |  2181038080 |           0 | {01K8JAAR4RSHA2AGEPB4XKBE70} | {}               |
| 19a85d0e-e5a2-4a1f-897a-dbf99c76c928 | {e25cd000-59be-4e52-86aa-fb4fc60a12c8} | {01KFDKMX7K27GP83NT8MWH08KB} | 2026-01-22 14:06:08+00 | 2026-01-22 14:06:08+00 | {0}    |           0 |  1073741824 | {01K8JAAR4RSHA2AGEPB4XKBE70} | {}               |
| 0785f071-0bb2-4362-a199-5802719417b6 | {f5f1ebe7-6946-4c2c-b4e5-18ac2d4f41e4} | {01KFFYN9QTKKEWJR02TTC5989Q} | 2026-01-22 13:26:04+00 | 2026-01-22 17:06:26+00 | {0}    |           0 | 24696061952 | {01HZ6QYPGPTKWG0XNRVZKYWNTS} | {}               |

* graph overall usage per hour

#+header: :engine postgres
#+header: :dbhost 127.0.0.1 :database requests :dbuser dev
#+header: :dbpassword dev
#+begin_src sql :exports both
  select
    user_id,
    cpu_request,
    min(capture_date) as min_date,
    max(capture_date) as max_date,
    (max(capture_date) - min(capture_date)) as duration
  from common.resource_requests_log
  where user_id is not null
    and phase in ('Bound', 'Running')
    and cpu_request > 0
  group by user_id, cpu_request
#+end_src

#+RESULTS:
| SET                                  |             |                        |                        |          |
|--------------------------------------+-------------+------------------------+------------------------+----------|
| user_id                              | cpu_request | min_date               | max_date               | duration |
| c59e6907-e670-4e03-a1b7-18616bb4678e |        0.54 | 2026-01-22 13:36:05+00 | 2026-01-22 16:36:24+00 | 03:00:19 |
| e25cd000-59be-4e52-86aa-fb4fc60a12c8 |        1.04 | 2026-01-22 14:06:08+00 | 2026-01-22 14:06:08+00 | 00:00:00 |


#+name: cpu_hours
#+header: :engine postgres
#+header: :dbhost 127.0.0.1 :database requests :dbuser dev
#+header: :dbpassword dev
#+begin_src sql :exports both
  with
    -- generate a list of hours of a given day
    hours as (
    select i as hour_of_day
    from generate_series(
      '2026-01-22T12:00:00Z'::timestamptz,
      '2026-01-22T20:00:00Z'::timestamptz,
      interval '1' hour) i
    ),

    -- list cpu request with the corresponding time it was observed
    cpu_requests as (
      select
        cpu_request,
        min(capture_date) as min_date,
        max(capture_date) as max_date,
        (max(capture_date) - min(capture_date)) as duration
      from common.resource_requests_log
      where user_id is not null
        and phase in ('Bound', 'Running')
        and cpu_request > 0
      group by cpu_request
    ),
    cpu_usage as (
      select
        hour_of_day,
        coalesce(cpu_request, 0) as cpu,
        min_date,
        max_date,
        greatest(hour_of_day, min_date) as usage_from,
        least(hour_of_day + interval '1' hour, max_date) as usage_to
      from hours h
      left join cpu_requests c on (
            extract(hour from h.hour_of_day) >= extract(hour from c.min_date)
        and extract(hour from h.hour_of_day) <= extract(hour from c.max_date)
      )
    ),
    cpu_hours as (
      select
        hour_of_day,
        cpu,
        greatest(interval '15' minute, usage_to - usage_from) as dur,
        cpu * greatest(0.25, extract(epoch from (usage_to - usage_from)) / 3600) as cpu_h
      from cpu_usage
    )
  select
    hour_of_day,
    sum(cpu_h) as cpu_h
  from cpu_hours
  group by hour_of_day
  order by hour_of_day
#+end_src

#+RESULTS: cpu_hours
| SET                    |                     |
|------------------------+---------------------|
| hour_of_day            |               cpu_h |
| 2026-01-22 12:00:00+00 |                   0 |
| 2026-01-22 13:00:00+00 | 0.21525000000000002 |
| 2026-01-22 14:00:00+00 |                 0.8 |
| 2026-01-22 15:00:00+00 |                0.54 |
| 2026-01-22 16:00:00+00 | 0.32760000000000006 |
| 2026-01-22 17:00:00+00 |                   0 |
| 2026-01-22 18:00:00+00 |                   0 |
| 2026-01-22 19:00:00+00 |                   0 |
| 2026-01-22 20:00:00+00 |                   0 |


#+begin_src R :exports both :results output :file plot.png :var cpu_hours=cpu_hours
  library(ggplot2)
  library(scales)

  data <- as.data.frame(cpu_hours)
  data <- subset(data, X >= 0)
  data$X <- as.numeric(data$X)
  data$SET <- as.POSIXct(data$SET, format="%Y-%m-%d %H:%M:%S", tz="UTC")
  data <- na.omit(data)

  plot <- ggplot(data, aes(x = SET, y = X)) +
    geom_line(color = "green", size = 2) +
    geom_point(color = "red") +
    labs(title = "CPU Hours",
         x = "Timestamp",
         y = "Fractional Values") +
    scale_x_datetime(breaks = data$SET, labels = date_format("%H:%M")) +
    theme_minimal()

  ggsave("plot.png", plot=plot)
#+end_src

#+RESULTS:

[[file:plot.png]]

* graph usage per user


#+name: cpu_hours_per_user
#+header: :engine postgres
#+header: :dbhost 127.0.0.1 :database requests :dbuser dev
#+header: :dbpassword dev
#+begin_src sql :exports both
  with
    -- generate a list of hours of a given day
    hours as (
    select i as hour_of_day
    from generate_series(
      '2026-01-22T12:00:00Z'::timestamptz,
      '2026-01-22T20:00:00Z'::timestamptz,
      interval '1' hour) i
    ),

    -- list cpu request with the corresponding time it was observed
    cpu_requests as (
      select
        user_id,
        cpu_request,
        min(capture_date) as min_date,
        max(capture_date) as max_date,
        (max(capture_date) - min(capture_date)) as duration
      from common.resource_requests_log
      where user_id is not null
        and phase in ('Bound', 'Running')
        and cpu_request > 0
      group by user_id, cpu_request
    ),
    memory_requests as (
      select
        user_id,
        memory_request,
        min(capture_date) as min_date,
        max(capture_date) as max_date,
        (max(capture_date) - min(capture_date)) as duration
      from common.resource_requests_log
      where user_id is not null
        and phase in ('Bound', 'Running')
        and cpu_request > 0
      group by user_id, memory_request
    ),
    cpu_usage as (
      select
        hour_of_day,
        user_id,
        coalesce(cpu_request, 0) as cpu,
        min_date,
        max_date,
        greatest(hour_of_day, min_date) as usage_from,
        least(hour_of_day + interval '1' hour, max_date) as usage_to
      from hours h
      left join cpu_requests c on (
            extract(hour from h.hour_of_day) >= extract(hour from c.min_date)
        and extract(hour from h.hour_of_day) <= extract(hour from c.max_date)
      )
    ),
    memory_usage as (
      select
        hour_of_day,
        user_id,
        coalesce(memory_request, 0) as memory,
        min_date,
        max_date,
        greatest(hour_of_day, min_date) as usage_from,
        least(hour_of_day + interval '1' hour, max_date) as usage_to
      from hours h
      left join memory_requests c on (
            extract(hour from h.hour_of_day) >= extract(hour from c.min_date)
        and extract(hour from h.hour_of_day) <= extract(hour from c.max_date)
      )
    ),
    cpu_hours as (
      select
        hour_of_day,
        user_id,
        cpu,
        greatest(interval '15' minute, usage_to - usage_from) as dur,
        cpu * greatest(0.25, extract(epoch from (usage_to - usage_from)) / 3600) as cpu_h
      from cpu_usage
    ),
    memory_hours as (
      select
        hour_of_day,
        user_id,
        memory,
        greatest(interval '15' minute, usage_to - usage_from) as dur,
        memory * greatest(0.25, extract(epoch from (usage_to - usage_from)) / 3600) as mem_h
      from memory_usage
    )
  select
    ch.hour_of_day,
    ch.user_id,
    sum(cpu_h) as cpu_h
  --  sum(mem_h) as mem_h
  from cpu_hours ch
--  left join memory_hours mh on mh.hour_of_day = ch.hour_of_day and mh.user_id = ch.user_id
  group by ch.hour_of_day, ch.user_id
  order by ch.hour_of_day, ch.user_id
#+end_src

#+RESULTS: cpu_hours_per_user
| SET                    |                                      |                     |
|------------------------+--------------------------------------+---------------------|
| hour_of_day            | user_id                              |               cpu_h |
| 2026-01-22 12:00:00+00 |                                      |                   0 |
| 2026-01-22 13:00:00+00 | c59e6907-e670-4e03-a1b7-18616bb4678e | 0.21525000000000002 |
| 2026-01-22 14:00:00+00 | c59e6907-e670-4e03-a1b7-18616bb4678e |                0.54 |
| 2026-01-22 14:00:00+00 | e25cd000-59be-4e52-86aa-fb4fc60a12c8 |                0.26 |
| 2026-01-22 15:00:00+00 | c59e6907-e670-4e03-a1b7-18616bb4678e |                0.54 |
| 2026-01-22 16:00:00+00 | c59e6907-e670-4e03-a1b7-18616bb4678e | 0.32760000000000006 |
| 2026-01-22 17:00:00+00 |                                      |                   0 |
| 2026-01-22 18:00:00+00 |                                      |                   0 |
| 2026-01-22 19:00:00+00 |                                      |                   0 |
| 2026-01-22 20:00:00+00 |                                      |                   0 |

* grouping per session

A session is identified by the tuple ~(user_id, launcher_id)~.

#+header: :engine postgres
#+header: :dbhost 127.0.0.1 :database requests :dbuser dev
#+header: :dbpassword dev
#+begin_src sql :exports both
  select
    user_id,
    launcher_id,
    min(capture_date) as min_date,
    max(capture_date) as max_date,
    sum(cpu_request) as cpu,
    sum(memory_request) as memory,
    sum(disk_request) as disk,
    array_agg(distinct since) as sinces

  from common.resource_requests_log
  where user_id is not null
    and phase in ('Bound', 'Running')
  --    and kind = 'PersistentVolumeClaim'
  --    and kind = 'Pod'
  group by user_id, launcher_id
#+end_src

#+RESULTS:
| SET                                  |                            |                        |                        |                    |             |             |                                                     |
|--------------------------------------+----------------------------+------------------------+------------------------+--------------------+-------------+-------------+-----------------------------------------------------|
| user_id                              | launcher_id                | min_date               | max_date               |                cpu |      memory |        disk | sinces                                              |
| 1a6d4c40-e500-419d-9812-22d6d1c27aa0 | 01K312ATNN2SEMPDE7XZPAX6E7 | 2026-01-22 13:26:04+00 | 2026-01-22 17:06:26+00 |                  0 |           0 | 24696061952 | {"2026-01-16 13:50:23+00"}                          |
| 4cf16e99-62fe-4889-90ba-38b2d02bd293 | 01KEESRJZ9TMVM4F0K7QNXDY1A | 2026-01-22 13:26:04+00 | 2026-01-22 17:06:26+00 |                  0 |           0 | 24696061952 | {"2026-01-08 12:37:14+00"}                          |
| 5daa2891-5310-4428-895d-10f859613223 | 01K82X2T9VKZRH7XQ19NRF2F3F | 2026-01-22 13:26:04+00 | 2026-01-22 17:06:26+00 |                  0 |           0 | 24696061952 | {"2026-01-15 13:11:17+00"}                          |
| c59e6907-e670-4e03-a1b7-18616bb4678e | 01KCVFZW2N6S20JAY67K30JNJ7 | 2026-01-22 13:26:04+00 | 2026-01-22 16:36:24+00 | 10.259999999999998 | 21038628864 | 21474836480 | {"2026-01-14 14:42:04+00","2026-01-22 13:29:44+00"} |
| e25cd000-59be-4e52-86aa-fb4fc60a12c8 | 01KFDKMX7K27GP83NT8MWH08KB | 2026-01-22 14:06:08+00 | 2026-01-22 14:06:08+00 |               1.04 |  2181038080 |  1073741824 | {"2026-01-22 14:04:53+00","2026-01-22 14:04:54+00"} |
| f5f1ebe7-6946-4c2c-b4e5-18ac2d4f41e4 | 01KFFYN9QTKKEWJR02TTC5989Q | 2026-01-22 13:26:04+00 | 2026-01-22 17:06:26+00 |                  0 |           0 | 24696061952 | {"2026-01-21 09:37:40+00"}                          |

* group by more flexible

insert test data

#+header: :engine postgres
#+header: :dbhost 127.0.0.1 :database requests :dbuser dev
#+header: :dbpassword dev
#+begin_src sql :exports both
select * from common.resource_requests_log limit 5;
#+end_src

#+RESULTS:
| SET                        |                            |           |                                                             |                                      |      |         |                        |         |            |             |                   |                  |                        |             |                |             |              |
|----------------------------+----------------------------+-----------+-------------------------------------------------------------+--------------------------------------+------+---------+------------------------+---------+------------+-------------+-------------------+------------------+------------------------+-------------+----------------+-------------+--------------|
| id                         | cluster_id                 | namespace | name                                                        | uid                                  | kind | phase   | capture_date           | user_id | project_id | launcher_id | resource_class_id | resource_pool_id | since                  | cpu_request | memory_request | gpu_request | disk_request |
| 01KFJY4C4CQRP8Z6204NS85APP | 0RENK1RENK2RENK3RENK4RENK5 | renku     | renku-amalthea-sessions-controller-manager-6b6486bc6c-hwhtk | 2f7c0196-4bcd-4d94-ade2-cb4f4ecbfaee | Pod  | Running | 2026-01-22 13:26:04+00 |         |            |             |                   |                  | 2026-01-17 01:10:06+00 |        0.01 |       67108864 |           0 |            0 |
| 01KFJY4C4E5H6CTWQP8W48WQ8E | 0RENK1RENK2RENK3RENK4RENK5 | renku     | renku-authz-6c89955499-dc8s7                                | 96ef39b2-45cc-42fc-a9b1-8196dd33b5a5 | Pod  | Running | 2026-01-22 13:26:04+00 |         |            |             |                   |                  | 2026-01-21 15:35:36+00 |           0 |              0 |           0 |            0 |
| 01KFJY4C4EEANTMCTXAAAT0CT1 | 0RENK1RENK2RENK3RENK4RENK5 | renku     | renku-csi-rclone-controller-0                               | 6a0eac50-aeef-4766-9ca7-ff974da1eff3 | Pod  | Running | 2026-01-22 13:26:04+00 |         |            |             |                   |                  | 2026-01-21 15:39:02+00 |         0.1 |      268435456 |           0 |            0 |
| 01KFJY4C4E1K9Y8BKN4HGDZXEG | 0RENK1RENK2RENK3RENK4RENK5 | renku     | renku-csi-rclone-nodeplugin-lxl5h                           | fd7f284d-99e3-4732-8103-fbf0666d23f8 | Pod  | Running | 2026-01-22 13:26:04+00 |         |            |             |                   |                  | 2026-01-21 13:07:16+00 |         0.2 |     1258291200 |           0 |            0 |
| 01KFJY4C4E9MPKV8ABQFTKZY35 | 0RENK1RENK2RENK3RENK4RENK5 | renku     | renku-data-service-774f7c6fd7-5lhqk                         | 2b269185-828e-4174-a372-537f110d99ef | Pod  | Running | 2026-01-22 13:26:04+00 |         |            |             |                   |                  | 2026-01-21 16:11:35+00 |         0.1 |      629145600 |           0 |            0 |


#+header: :engine postgres
#+header: :dbhost 127.0.0.1 :database requests :dbuser dev
#+header: :dbpassword dev
#+begin_src sql :exports both
  delete from common.resource_requests_log;
  insert into common.resource_requests_log
    (cluster_id, uid, namespace, name, kind, phase, capture_date, capture_interval, user_id, project_id, launcher_id, resource_class_id, resource_pool_id, since, cpu_request, memory_request, gpu_request, disk_request)
    values
    ('0RENK1RENK2RENK3RENK4RENK5', 'uid-1','renku', 'my-pod-15','Pod','Running', '2026-01-22 13:26:04+00'::timestamptz, '10 minute'::interval, 'user1', 'project-1','launcher-1',4,5,null,0.5,512*1024,null,null),
    ('0RENK1RENK2RENK3RENK4RENK5', 'uid-1','renku', 'my-pod-15','Pod','Running', '2026-01-22 13:36:04+00'::timestamptz, '10 minute'::interval, 'user1', 'project-1','launcher-1',4,5,null,0.5,512*1024,null,null),
    ('0RENK1RENK2RENK3RENK4RENK5', 'uid-1','renku', 'my-pod-15','Pod','Running', '2026-01-22 13:46:04+00'::timestamptz, '10 minute'::interval, 'user1', 'project-1','launcher-1',4,5,null,0.5,512*1024,null,null),
      -- pod is down
    ('0RENK1RENK2RENK3RENK4RENK5', 'uid-1','renku', 'my-pod-15','Pod','Stopped', '2026-01-22 13:56:04+00'::timestamptz, '10 minute'::interval, 'user1', 'project-1','launcher-1',4,5,null,0.5,512*1024,null,null),
    ('0RENK1RENK2RENK3RENK4RENK5', 'uid-1','renku', 'my-pod-15','Pod','Stopped', '2026-01-22 14:06:04+00'::timestamptz, '10 minute'::interval, 'user1', 'project-1','launcher-1',4,5,null,0.5,512*1024,null,null),
    ('0RENK1RENK2RENK3RENK4RENK5', 'uid-1','renku', 'my-pod-15','Pod','Stopped', '2026-01-22 14:16:04+00'::timestamptz, '10 minute'::interval, 'user1', 'project-1','launcher-1',4,5,null,0.5,512*1024,null,null),
    ('0RENK1RENK2RENK3RENK4RENK5', 'uid-1','renku', 'my-pod-15','Pod','Stopped', '2026-01-22 14:26:04+00'::timestamptz, '10 minute'::interval, 'user1', 'project-1','launcher-1',4,5,null,0.5,512*1024,null,null),
      -- pod is up again
    ('0RENK1RENK2RENK3RENK4RENK5', 'uid-1','renku', 'my-pod-15','Pod','Running', '2026-01-22 14:36:04+00'::timestamptz, '10 minute'::interval, 'user1', 'project-1','launcher-1',4,5,null,0.5,512*1024,null,null),
      -- we don't observe this pod for some time
    ('0RENK1RENK2RENK3RENK4RENK5', 'uid-1','renku', 'my-pod-15','Pod','Running', '2026-01-22 15:46:04+00'::timestamptz, '10 minute'::interval, 'user1', 'project-1','launcher-1',4,5,null,0.5,512*1024,null,null),
    ('0RENK1RENK2RENK3RENK4RENK5', 'uid-1','renku', 'my-pod-15','Pod','Running', '2026-01-22 15:56:04+00'::timestamptz, '10 minute'::interval, 'user1', 'project-1','launcher-1',4,5,null,0.5,512*1024,null,null),
      -- logging is restarted after 5min
    ('0RENK1RENK2RENK3RENK4RENK5', 'uid-1','renku', 'my-pod-15','Pod','Running', '2026-01-22 16:01:04+00'::timestamptz, '10 minute'::interval, 'user1', 'project-1','launcher-1',4,5,null,0.5,512*1024,null,null),
    ('0RENK1RENK2RENK3RENK4RENK5', 'uid-1','renku', 'my-pod-15','Pod','Running', '2026-01-22 16:11:04+00'::timestamptz, '10 minute'::interval, 'user1', 'project-1','launcher-1',4,5,null,0.5,512*1024,null,null),
    ('0RENK1RENK2RENK3RENK4RENK5', 'uid-1','renku', 'my-pod-15','Pod','Running', '2026-01-22 16:21:04+00'::timestamptz, '10 minute'::interval, 'user1', 'project-1','launcher-1',4,5,null,0.5,512*1024,null,null)
  ;

#+end_src

#+RESULTS:
| SET         |
|-------------|
| DELETE 13   |
| INSERT 0 13 |


Things to watch out:
- task gets restarted in the middle of the interval
- task crashes/is shut down and doesn't collect for x-time
  - no observation = nothing provided/running = no costs
  - if a pod disappears for some time it means it is not scheduled and
    doesn't consume resources (= no costs)
- gpu usage depends on the fraction of the gpu being utilised


#+name: grouping_test_2
#+header: :engine postgres
#+header: :dbhost 127.0.0.1 :database requests :dbuser dev
#+header: :dbpassword dev
#+begin_src sql :exports both
      with
        cpu_obs as (
          select *, row_number() over (order by capture_date asc) as rn
          from common.resource_requests_log
          where cpu_request is not null and user_id is not null
          order by capture_date asc
        ),
        mem_obs as (
          select *, row_number() over (order by capture_date asc) as rn
          from common.resource_requests_log
          where memory_request is not null and user_id is not null
          order by capture_date asc
        ),
        disk_obs as (
          select *, row_number() over (order by capture_date asc) as rn
          from common.resource_requests_log
          where disk_request is not null and user_id is not null
          order by capture_date asc
        ),
        gpu_obs as (
          select *, row_number() over (order by capture_date asc) as rn
          from common.resource_requests_log
          where gpu_request is not null and user_id is not null
          order by capture_date asc
        ),
        requests_diffs as (
          select
            t.id,
            t.cluster_id,
            t.namespace,
            t.name,
            t.uid,
            t.kind,
            t.phase,
            t.user_id,
            t.project_id,
            t.launcher_id,
            t.resource_class_id,
            t.resource_pool_id,
            t.cpu_request,
            t.memory_request,
            t.disk_request,
            t.gpu_request,
            t.gpu_slice,
            t.capture_date,
            t.capture_interval,
            cpu_prev.capture_date as cpu_prev_date
          from common.resource_requests_log t
          left join cpu_obs cpu_prev on cpu_prev.rn = (select max(rn) from cpu_obs where rn < (select row_number() over (order by capture_date asc) from cpu_obs where capture_date = t.capture_date))
          where t.user_id is not null
          order by capture_date asc
        ),
        -- add the timespan the value was observed: next observation date - this observation date
        -- using the configured interval for the last observation
        final_requests_diffs as (
          select
            id,
            cluster_id,
            namespace,
            name,
            uid,
            kind,
            phase,
            user_id,
            project_id,
            launcher_id,
            resource_class_id,
            resource_pool_id,
            cpu_request,
            memory_request,
            disk_request,
            gpu_request,
            gpu_slice,
            capture_date,
            capture_interval
          from common.resource_requests_log
          where phase in ('Running', 'Bound')
            and user_id is not null
            and (cpu_request > 0 or memory_request > 0 or disk_request > 0)
        ),
        -- ^ this could be a view


        -- do a query for listing usage per hour given a single day
        hourly_buckets as (
          select h as hour_of_day
          from generate_series(
            date_trunc('hour', '2026-01-22T00:00:00Z'::timestamp),
            date_trunc('hour', '2026-01-23T00:00:00Z'::timestamp),
            '1 hour'::interval
          ) as h
        ),
        -- need to split the time series a the hour edges
        splitted as (
          select hour_of_day, uid, user_id, capture_date,
            t.cpu_request, t.memory_request, t.disk_request, t.gpu_request,
            coalesce(least(t.capture_date + t.capture_interval, b.hour_of_day + '1 hour'::interval) - greatest(t.capture_date, b.hour_of_day), '0 hour'::interval) as cpu_time,
            coalesce(least(t.capture_date + t.capture_interval, b.hour_of_day + '1 hour'::interval) - greatest(t.capture_date, b.hour_of_day), '0 hour'::interval) as memory_time,
            coalesce(least(t.capture_date + t.capture_interval, b.hour_of_day + '1 hour'::interval) - greatest(t.capture_date, b.hour_of_day), '0 hour'::interval) as disk_time
          from final_requests_diffs t
          join hourly_buckets b
            on t.capture_date < b.hour_of_day + '1 hour'::interval
           and t.capture_date + t.capture_interval > b.hour_of_day

        ),
        -- now calculate the usage by creating "cpu hours" etc
        -- (extract(epoch from cpu_time) / 3600) converts the interval in hours
        request_hours as (
          select
            hour_of_day,
            uid, user_id,
            capture_date,
            sum(cpu_time) as cpu_time, sum(cpu_request) * (extract(epoch from sum(cpu_time)) / 3600) as cpu_hours,
            sum(memory_time) as memory_time, sum(memory_request) * (extract(epoch from sum(memory_time)) / 3600) as mem_hours,
            sum(disk_time) as disk_time, sum(disk_request) * (extract(epoch from sum(disk_time)) / 3600) as disk_hours,
            sum(cpu_request) as cpu_request,
            sum(memory_request) as memory_request,
            sum(disk_request) as disk_request
          from splitted
          group by hour_of_day, uid, user_id, capture_date
        )
        -- -- could group by user etc
        -- per_user as (
        --   select hour_of_day, user_id, sum(cpu_hours) as cpu_hours, sum(mem_hours) as mem_hours, sum(disk_hours) as disk_hours
        --   from request_hours
        --   group by hour_of_day, user_id
        -- )
      select * from requests_diffs
      order by capture_date
  --     where user_id like 'c59e6907-e670-4e03-a1b7-18616bb4678e'
  --    order by uid, hour_of_day, capture_date
    --  order by user_id, hour_of_day

#+end_src

#+RESULTS: grouping_test_2
| SET                        |                            |           |           |       |      |         |         |            |             |                   |                  |             |                |              |             |           |                        |                  |               |
|----------------------------+----------------------------+-----------+-----------+-------+------+---------+---------+------------+-------------+-------------------+------------------+-------------+----------------+--------------+-------------+-----------+------------------------+------------------+---------------|
| id                         | cluster_id                 | namespace | name      | uid   | kind | phase   | user_id | project_id | launcher_id | resource_class_id | resource_pool_id | cpu_request | memory_request | disk_request | gpu_request | gpu_slice | capture_date           | capture_interval | cpu_prev_date |
| 01KG4XP8Y5TSAMSB92Y6KWRRE0 | 0RENK1RENK2RENK3RENK4RENK5 | renku     | my-pod-15 | uid-1 | Pod  | Running | user1   | project-1  | launcher-1  |                 4 |                5 |         0.5 |         524288 |              |             |           | 2026-01-22 13:26:04+00 |         00:10:00 |               |
| 01KG4XP8Y7JVNTKE5QJC4SEGV2 | 0RENK1RENK2RENK3RENK4RENK5 | renku     | my-pod-15 | uid-1 | Pod  | Running | user1   | project-1  | launcher-1  |                 4 |                5 |         0.5 |         524288 |              |             |           | 2026-01-22 13:36:04+00 |         00:10:00 |               |
| 01KG4XP8Y75DB2TAH2G28574B1 | 0RENK1RENK2RENK3RENK4RENK5 | renku     | my-pod-15 | uid-1 | Pod  | Running | user1   | project-1  | launcher-1  |                 4 |                5 |         0.5 |         524288 |              |             |           | 2026-01-22 13:46:04+00 |         00:10:00 |               |
| 01KG4XP8Y7M6B35VZHDS1WN6NP | 0RENK1RENK2RENK3RENK4RENK5 | renku     | my-pod-15 | uid-1 | Pod  | Stopped | user1   | project-1  | launcher-1  |                 4 |                5 |         0.5 |         524288 |              |             |           | 2026-01-22 13:56:04+00 |         00:10:00 |               |
| 01KG4XP8Y7GRCYBENEQJ0FK7J3 | 0RENK1RENK2RENK3RENK4RENK5 | renku     | my-pod-15 | uid-1 | Pod  | Stopped | user1   | project-1  | launcher-1  |                 4 |                5 |         0.5 |         524288 |              |             |           | 2026-01-22 14:06:04+00 |         00:10:00 |               |
| 01KG4XP8Y7A35Q0DFW4DT08D7J | 0RENK1RENK2RENK3RENK4RENK5 | renku     | my-pod-15 | uid-1 | Pod  | Stopped | user1   | project-1  | launcher-1  |                 4 |                5 |         0.5 |         524288 |              |             |           | 2026-01-22 14:16:04+00 |         00:10:00 |               |
| 01KG4XP8Y746S6PW7YXKJTX0KY | 0RENK1RENK2RENK3RENK4RENK5 | renku     | my-pod-15 | uid-1 | Pod  | Stopped | user1   | project-1  | launcher-1  |                 4 |                5 |         0.5 |         524288 |              |             |           | 2026-01-22 14:26:04+00 |         00:10:00 |               |
| 01KG4XP8Y7R1FWVJMGXF96W1BD | 0RENK1RENK2RENK3RENK4RENK5 | renku     | my-pod-15 | uid-1 | Pod  | Running | user1   | project-1  | launcher-1  |                 4 |                5 |         0.5 |         524288 |              |             |           | 2026-01-22 14:36:04+00 |         00:10:00 |               |
| 01KG4XP8Y7XRQWVAQ4CK0C4MHD | 0RENK1RENK2RENK3RENK4RENK5 | renku     | my-pod-15 | uid-1 | Pod  | Running | user1   | project-1  | launcher-1  |                 4 |                5 |         0.5 |         524288 |              |             |           | 2026-01-22 15:46:04+00 |         00:10:00 |               |
| 01KG4XP8Y7PBAAPPZ2T8MT0H46 | 0RENK1RENK2RENK3RENK4RENK5 | renku     | my-pod-15 | uid-1 | Pod  | Running | user1   | project-1  | launcher-1  |                 4 |                5 |         0.5 |         524288 |              |             |           | 2026-01-22 15:56:04+00 |         00:10:00 |               |
| 01KG4XP8Y7E96XGXAYYW986KSW | 0RENK1RENK2RENK3RENK4RENK5 | renku     | my-pod-15 | uid-1 | Pod  | Running | user1   | project-1  | launcher-1  |                 4 |                5 |         0.5 |         524288 |              |             |           | 2026-01-22 16:01:04+00 |         00:10:00 |               |
| 01KG4XP8Y7MJ8FN3D57YJVFPJZ | 0RENK1RENK2RENK3RENK4RENK5 | renku     | my-pod-15 | uid-1 | Pod  | Running | user1   | project-1  | launcher-1  |                 4 |                5 |         0.5 |         524288 |              |             |           | 2026-01-22 16:11:04+00 |         00:10:00 |               |
| 01KG4XP8Y7YT5HCQJ55DPM7KWS | 0RENK1RENK2RENK3RENK4RENK5 | renku     | my-pod-15 | uid-1 | Pod  | Running | user1   | project-1  | launcher-1  |                 4 |                5 |         0.5 |         524288 |              |             |           | 2026-01-22 16:21:04+00 |         00:10:00 |               |

#+header: :engine postgres
#+header: :dbhost 127.0.0.1 :database renku :dbuser dev
#+header: :dbpassword dev
#+begin_src sql :exports both
  with
    cpu_obs as (
      select id, capture_date, dense_rank() over (order by capture_date asc) as rn
      from common.resource_requests_log
      where cpu_request is not null and user_id is not null
    ),
    mem_obs as (
      select id, capture_date, dense_rank() over (order by capture_date asc) as rn
      from common.resource_requests_log
      where memory_request is not null and user_id is not null
    ),
    disk_obs as (
      select id, capture_date, dense_rank() over (order by capture_date asc) as rn
      from common.resource_requests_log
      where disk_request is not null and user_id is not null
    ),
    gpu_obs as (
      select id, capture_date, dense_rank() over (order by capture_date asc) as rn
      from common.resource_requests_log
      where gpu_request is not null and user_id is not null
    ),
    requests_diffs as (
      select
        t.id,
        t.cluster_id,
        t.namespace,
        t.name,
        t.uid,
        t.kind,
        t.phase,
        t.user_id,
        t.project_id,
        t.launcher_id,
        t.resource_class_id,
        t.resource_pool_id,
        t.cpu_request,
        t.memory_request,
        t.disk_request,
        t.gpu_request,
        t.gpu_slice,
        t.capture_date,
        t.capture_interval,
        -- cpu next capture date
        (select min(c.capture_date) from cpu_obs c where c.rn = cs.rn + 1) as cpu_next_date,
        -- memory next capture date
        (select min(c.capture_date) from mem_obs c where c.rn = ms.rn + 1) as mem_next_date,
        -- disk next capture date
        (select min(c.capture_date) from disk_obs c where c.rn = ds.rn + 1) as disk_next_date,
        -- gpu next capture date
        (select min(c.capture_date) from gpu_obs c where c.rn = gs.rn + 1) as gpu_next_date
      from common.resource_requests_log t
      left join cpu_obs cs on cs.id = t.id
      left join mem_obs ms on ms.id = t.id
      left join disk_obs ds on ds.id = t.id
      left join gpu_obs gs on gs.id = t.id
      where t.user_id is not null
        and t.phase in ('Running', 'Bound')
      order by t.capture_date asc
    )
    select
      t.id,
      t.cluster_id,
      t.namespace,
      t.name,
      t.uid,
      t.kind,
      t.phase,
      t.user_id,
      t.project_id,
      t.launcher_id,
      t.resource_class_id,
      t.resource_pool_id,
      t.cpu_request,
      t.memory_request,
      t.disk_request,
      t.gpu_request,
      t.gpu_slice,
      t.capture_date,
      t.capture_interval,
      case
        when t.cpu_request is null then null
        else least(t.cpu_next_date - t.capture_date, t.capture_interval)
      end as cpu_time,
      case
        when t.memory_request is null then null
        else least(t.mem_next_date - t.capture_date, t.capture_interval)
      end as mem_time,
      case
         when t.gpu_request is null then null
         else least(t.gpu_next_date - t.capture_date, t.capture_interval)
      end as gpu_time,
      case
         when t.disk_request is null then null
         else least(t.disk_next_date - t.capture_date, t.capture_interval)
      end as disk_time
    from requests_diffs t
    order by t.capture_date asc

#+end_src

#+RESULTS:
| SET                        |                            |           |                             |                                      |                       |         |                                      |                            |                            |                   |                  |             |                |              |             |           |                        |                  |          |          |          |           |
|----------------------------+----------------------------+-----------+-----------------------------+--------------------------------------+-----------------------+---------+--------------------------------------+----------------------------+----------------------------+-------------------+------------------+-------------+----------------+--------------+-------------+-----------+------------------------+------------------+----------+----------+----------+-----------|
| id                         | cluster_id                 | namespace | name                        | uid                                  | kind                  | phase   | user_id                              | project_id                 | launcher_id                | resource_class_id | resource_pool_id | cpu_request | memory_request | disk_request | gpu_request | gpu_slice | capture_date           | capture_interval | cpu_time | mem_time | gpu_time | disk_time |
| 01KG5163MF9TD1C8527XP5ZJEW | 0RENK1RENK2RENK3RENK4RENK5 | renku     | ekettner-20dec419087c       | 0785f071-0bb2-4362-a199-5802719417b6 | PersistentVolumeClaim | Bound   | f5f1ebe7-6946-4c2c-b4e5-18ac2d4f41e4 | 01HZ6QYPGPTKWG0XNRVZKYWNTS | 01KFFYN9QTKKEWJR02TTC5989Q |                   |                  |             |                |   1073741824 |             |           | 2026-01-29 14:05:46+00 |         00:10:00 |          |          |          |  00:10:00 |
| 01KG5163MGJ43VP58211K2CGWD | 0RENK1RENK2RENK3RENK4RENK5 | renku     | lorenzo-cava-6735b6189e50   | 4756ee2b-7b94-42c9-9b2f-dd783a2863ab | PersistentVolumeClaim | Bound   | 5daa2891-5310-4428-895d-10f859613223 | 01K82WQ20PNMCTDR7A6JD4B3A8 | 01K82X2T9VKZRH7XQ19NRF2F3F |                   |                  |             |                |   1073741824 |             |           | 2026-01-29 14:05:46+00 |         00:10:00 |          |          |          |  00:10:00 |
| 01KG5163MG7ZDENV55Z1GT78RZ | 0RENK1RENK2RENK3RENK4RENK5 | renku     | lorenzo-cava-6e077c544338   | cd2ef30b-8bf4-40f2-a7e1-f90efa99789d | PersistentVolumeClaim | Bound   | 5daa2891-5310-4428-895d-10f859613223 | 01K82WQ20PNMCTDR7A6JD4B3A8 | 01KFNKP1QNGZ74SQSCV8DK53KY |                   |                  |             |                |   1073741824 |             |           | 2026-01-29 14:05:46+00 |         00:10:00 |          |          |          |  00:10:00 |
| 01KG51RE84E4ZFT7GKWXN40BFY | 0RENK1RENK2RENK3RENK4RENK5 | renku     | eike-kettner-962026d34ba4-0 | cb1ab2e2-535f-470b-b7c7-d7b00fce91a8 | Pod                   | Running | c59e6907-e670-4e03-a1b7-18616bb4678e | 01KCVFX9BVTADB8SGHN7RJFJAP | 01KCVFZW2N6S20JAY67K30JNJ7 |                   |                  |        0.54 |     1107296256 |            0 |             |           | 2026-01-29 14:15:47+00 |         00:10:00 | 00:10:00 | 00:10:00 |          |  00:10:00 |
| 01KG51RE89GNVXHP88F4WAX3W0 | 0RENK1RENK2RENK3RENK4RENK5 | renku     | eike-kettner-962026d34ba4   | c60ae7a9-590f-43fc-b999-1dffe30d9be7 | PersistentVolumeClaim | Bound   | c59e6907-e670-4e03-a1b7-18616bb4678e | 01KCVFX9BVTADB8SGHN7RJFJAP | 01KCVFZW2N6S20JAY67K30JNJ7 |                   |                  |             |                |   1073741824 |             |           | 2026-01-29 14:15:47+00 |         00:10:00 |          |          |          |  00:10:00 |
| 01KG51RE89J1XW32XPZ3HYPXJZ | 0RENK1RENK2RENK3RENK4RENK5 | renku     | ekettner-20dec419087c       | 0785f071-0bb2-4362-a199-5802719417b6 | PersistentVolumeClaim | Bound   | f5f1ebe7-6946-4c2c-b4e5-18ac2d4f41e4 | 01HZ6QYPGPTKWG0XNRVZKYWNTS | 01KFFYN9QTKKEWJR02TTC5989Q |                   |                  |             |                |   1073741824 |             |           | 2026-01-29 14:15:47+00 |         00:10:00 |          |          |          |  00:10:00 |
| 01KG51RE895QBEGA9NBXM4GRFW | 0RENK1RENK2RENK3RENK4RENK5 | renku     | lorenzo-cava-6735b6189e50   | 4756ee2b-7b94-42c9-9b2f-dd783a2863ab | PersistentVolumeClaim | Bound   | 5daa2891-5310-4428-895d-10f859613223 | 01K82WQ20PNMCTDR7A6JD4B3A8 | 01K82X2T9VKZRH7XQ19NRF2F3F |                   |                  |             |                |   1073741824 |             |           | 2026-01-29 14:15:47+00 |         00:10:00 |          |          |          |  00:10:00 |
| 01KG51RE89WG9NEHZGGY7VSEQD | 0RENK1RENK2RENK3RENK4RENK5 | renku     | lorenzo-cava-6e077c544338   | cd2ef30b-8bf4-40f2-a7e1-f90efa99789d | PersistentVolumeClaim | Bound   | 5daa2891-5310-4428-895d-10f859613223 | 01K82WQ20PNMCTDR7A6JD4B3A8 | 01KFNKP1QNGZ74SQSCV8DK53KY |                   |                  |             |                |   1073741824 |             |           | 2026-01-29 14:15:47+00 |         00:10:00 |          |          |          |  00:10:00 |

       (select c.capture_date from disk_obs c where c.rn = ds.rn - 1) as disk_prev_date,


| SET   |         |             |                |              |             |                        |                  |          |          |           |          |
|-------+---------+-------------+----------------+--------------+-------------+------------------------+------------------+----------+----------+-----------+----------|
| uid   | phase   | cpu_request | memory_request | disk_request | gpu_request | capture_date           | capture_interval | cpu_time | mem_time | disk_time | gpu_time |
| uid-1 | Running |         0.5 |         524288 |              |             | 2026-01-22 13:26:04+00 |         00:10:00 | 00:10:00 | 00:10:00 |           |          |
| uid-1 | Running |         0.5 |         524288 |              |             | 2026-01-22 13:36:04+00 |         00:10:00 | 00:10:00 | 00:10:00 |           |          |
| uid-1 | Running |         0.5 |         524288 |              |             | 2026-01-22 13:46:04+00 |         00:10:00 | 00:10:00 | 00:10:00 |           |          |
| uid-1 | Running |         0.5 |         524288 |              |             | 2026-01-22 14:36:04+00 |         00:10:00 | 00:10:00 | 00:10:00 |           |          |
| uid-1 | Running |         0.5 |         524288 |              |             | 2026-01-22 15:46:04+00 |         00:10:00 | 00:10:00 | 00:10:00 |           |          |
| uid-1 | Running |         0.5 |         524288 |              |             | 2026-01-22 15:56:04+00 |         00:10:00 | 00:05:00 | 00:05:00 |           |          |
| uid-1 | Running |         0.5 |         524288 |              |             | 2026-01-22 16:01:04+00 |         00:10:00 | 00:10:00 | 00:10:00 |           |          |
| uid-1 | Running |         0.5 |         524288 |              |             | 2026-01-22 16:11:04+00 |         00:10:00 | 00:10:00 | 00:10:00 |           |          |
| uid-1 | Running |         0.5 |         524288 |              |             | 2026-01-22 16:21:04+00 |         00:10:00 | 00:10:00 | 00:10:00 |           |          |


#+header: :engine postgres
#+header: :dbhost 127.0.0.1 :database renku :dbuser dev
#+header: :dbpassword dev
#+begin_src sql :exports both

  select capture_date, dense_rank() over (order by capture_date asc) as rn
  from common.resource_requests_log
  where disk_request is not null and user_id is not null



#+end_src

#+RESULTS:
| SET                    |    |
|------------------------+----|
| capture_date           | rn |
| 2026-01-29 14:05:46+00 |  1 |
| 2026-01-29 14:05:46+00 |  1 |
| 2026-01-29 14:05:46+00 |  1 |
| 2026-01-29 14:15:47+00 |  2 |
| 2026-01-29 14:15:47+00 |  2 |
| 2026-01-29 14:15:47+00 |  2 |
| 2026-01-29 14:15:47+00 |  2 |
| 2026-01-29 14:15:47+00 |  2 |
