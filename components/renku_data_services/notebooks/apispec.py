# generated by datamodel-codegen:
#   filename:  api.spec.yaml
#   timestamp: 2026-02-17T20:15:52+00:00

from __future__ import annotations

from datetime import datetime
from enum import Enum
from typing import Any, Dict, List, Optional, Union

from pydantic import Field, RootModel
from renku_data_services.notebooks.apispec_base import BaseAPISpec


class EnvVarOverride(BaseAPISpec):
    name: str = Field(
        ..., examples=["MY_VAR"], max_length=256, pattern="^[a-zA-Z_][a-zA-Z0-9_]*$"
    )
    value: str = Field(..., max_length=500)


class Error(BaseAPISpec):
    code: int = Field(..., examples=[1404], gt=0)
    detail: Optional[str] = Field(
        None, examples=["A more detailed optional message showing what the problem was"]
    )
    message: str = Field(
        ..., examples=["Something went wrong - please try again later"]
    )
    trace_id: Optional[str] = Field(
        None,
        description="Sentry trace ID for linking to corresponding log entries",
        examples=["ac93950e9e114a55c67fb8e5ef519bbe"],
    )


class ErrorResponse(BaseAPISpec):
    error: Error


class State(Enum):
    running = "running"
    hibernated = "hibernated"


class CurrentTime(Enum):
    now = "now"


class State1(Enum):
    running = "running"
    starting = "starting"
    stopping = "stopping"
    failed = "failed"
    hibernated = "hibernated"


class SessionStatus(BaseAPISpec):
    message: Optional[str] = None
    state: State1
    will_hibernate_at: Optional[datetime] = None
    will_delete_at: Optional[datetime] = None
    ready_containers: int = Field(..., ge=0)
    total_containers: int = Field(..., ge=0)


class SessionResourcesRequests(BaseAPISpec):
    cpu: Optional[float] = Field(None, description="Fractional CPUs")
    gpu: Optional[int] = Field(None, description="Number of GPUs used")
    memory: Optional[int] = Field(
        None, description="Ammount of RAM for the session, in gigabytes"
    )
    storage: Optional[int] = Field(
        None, description="The size of disk storage for the session, in gigabytes"
    )


class SessionLogsResponse(RootModel[Optional[Dict[str, str]]]):
    root: Optional[Dict[str, str]] = None


class ImageConnectionStatus(Enum):
    connected = "connected"
    pending = "pending"
    invalid_credentials = "invalid_credentials"


class ImageProvider(BaseAPISpec):
    id: str
    name: str
    url: str


class ImagePlatform(BaseAPISpec):
    architecture: str
    os: str
    os_version: Optional[str] = Field(None, alias="os.version")
    os_features: Optional[List[str]] = Field(None, alias="os.features")
    variant: Optional[str] = None


class SessionsSessionIdLogsGetParametersQuery(BaseAPISpec):
    max_lines: int = 250


class SessionsImagesGetParametersQuery(BaseAPISpec):
    image_url: str = Field(..., min_length=1)


class SessionPatchRequest(BaseAPISpec):
    resource_class_id: Optional[int] = None
    state: Optional[State] = None
    lastInteraction: Optional[Union[datetime, CurrentTime]] = None


class SessionResources(BaseAPISpec):
    requests: Optional[SessionResourcesRequests] = None


class SessionDataConnectorOverride(BaseAPISpec):
    skip: bool = Field(
        False,
        description="The corresponding data connector will not be mounted if `skip` is set to `true`.",
    )
    data_connector_id: str = Field(
        ...,
        description="ULID identifier",
        max_length=26,
        min_length=26,
        pattern="^[0-7][0-9A-HJKMNP-TV-Z]{25}$",
    )
    configuration: Optional[
        Dict[str, Union[int, Optional[str], bool, Dict[str, Any]]]
    ] = None
    source_path: Optional[str] = Field(
        None,
        description="the source path to mount, usually starts with bucket/container name",
        examples=["bucket/my/storage/folder/"],
    )
    target_path: Optional[str] = Field(
        None,
        description="the target path relative to the working directory where the storage should be mounted",
        examples=["my/project/folder"],
    )
    readonly: Optional[bool] = Field(
        True, description="Whether this storage should be mounted readonly or not"
    )


class ImageConnection(BaseAPISpec):
    id: str
    provider_id: str
    status: ImageConnectionStatus


class SessionResponse(BaseAPISpec):
    image: str
    name: str = Field(
        ...,
        examples=["d185e68d-d43-renku-2-b9ac279a4e8a85ac28d08"],
        max_length=50,
        min_length=5,
        pattern="^[a-z]([-a-z0-9]*[a-z0-9])?$",
    )
    resources: SessionResources
    started: Optional[datetime] = Field(...)
    lastInteraction: Optional[datetime] = None
    status: SessionStatus
    url: str
    project_id: str = Field(
        ...,
        description="ULID identifier",
        max_length=26,
        min_length=26,
        pattern="^[0-7][0-9A-HJKMNP-TV-Z]{25}$",
    )
    launcher_id: str = Field(
        ...,
        description="ULID identifier",
        max_length=26,
        min_length=26,
        pattern="^[0-7][0-9A-HJKMNP-TV-Z]{25}$",
    )
    resource_class_id: int


class SessionListResponse(RootModel[List[SessionResponse]]):
    root: List[SessionResponse]


class ImageCheckResponse(BaseAPISpec):
    accessible: bool = Field(..., description="Whether the image is accessible or not.")
    platforms: Optional[List[ImagePlatform]] = Field(
        None, description="The list of platforms an image can run on."
    )
    connection: Optional[ImageConnection] = None
    provider: Optional[ImageProvider] = None


class SessionPostRequest(BaseAPISpec):
    launcher_id: str = Field(
        ...,
        description="ULID identifier",
        max_length=26,
        min_length=26,
        pattern="^[0-7][0-9A-HJKMNP-TV-Z]{25}$",
    )
    disk_storage: Optional[int] = Field(
        None, description="The size of disk storage for the session, in gigabytes"
    )
    resource_class_id: Optional[int] = None
    data_connectors_overrides: Optional[List[SessionDataConnectorOverride]] = None
    env_variable_overrides: Optional[List[EnvVarOverride]] = Field(
        None, description="Environment variable overrides for the session pod"
    )
